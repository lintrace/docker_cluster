# Docker_cluster

#### Скрипт для развертывания кластера из N серверных узлов посредством Docker на локальной Linux-машине. Создавался с целью развертки кластера для тестов с нужным количеством узлов и версией GridGain

Это второй вариант скрипта с учетом высказанных пожеланий, от 04 May 2021, 10:03 PM

Ключевые особенности от предыдущего варианта: не плодится множество образов (image) для каждого узла. Используется всего один базовый образ для всех узлов. 

Для каждого узла по-прежнему формируется своя папка, в нее копируется конфиг, который также генерируется для каждого узла из шаблона, помимо этого создается рабочая директория work. Затем для каждого контейнера монтируется своя папка в /gg и запускается грид со своим конфигом.

Полностью переделано сетевое взаимодействие, теперь используется дефолтный bridge
"Subnet": "172.19.0.0/16",   "Gateway": "172.19.0.1"
узлы доступны по адресам 172.19.0.2 и выше

Требования: OS Linux, python3, docker, docker-compose

Скрипт для запуска: CreateCluster.py

Директория templates содержит шаблоны, которые будут смонтированы  в каталог /gg в контейнерах.

В файле скрипта CreateCluster.py ищем и устанавливаем параметры:

**nodes** = требуемое количество СУ в создаваемом кластере  
**base_image** = базовый образ GridGain на DockerHub. Иными словами, требуемая версия грида.  
**tcp_discovery_Port** = начальный порт TcpDiscovery  

Пример:
```
# Number of nodes
nodes = 2

# GG version (you must place here a desired image name from DockerHub)**
base_image = "gridgain/ultimate:8.7.35-openjdk8"

#TcpDiscoveryPort
tcp_discovery_Port = 47500
```
Все файлы из папки templates будут скопированы в папки монтируемые к контейнерам node000 - nodeNNN с заменой строковых шаблонов (проверяются и заменяются строковые шаблоны во ВСЕХ файлах шаблонов). Для прототипа доступны:
```
<<base_docker_image>> - базовый образ GridGain на DockerHub   
<<consistentId>> - имя узла, оно же имя папки образа (node000 - nodeNNN)   
<<tcp_discovery_ports_range>> - диапазон портов TcpDiscovery, вычисленный на основании первого порта и количества узлов. Пример: 47500..47505   
```
--------------------------------------


Для приведения системы к первоначальному виду (удаления всех внесенных скриптом изменений) необходимо выполнить следующие шаги:
```
1. sudo docker-compose down
2. sudo ip link set macvln0 down
3. sudo ip addr delete 192.168.10.1/24 dev macvln0
4. sudo ip link delete macvln0 link wlp4s0 type macvlan mode bridge
5. sudo docker network rm gg_net
```
